<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coding Practice Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-dark:#0a0f1c; --card-dark:rgba(255,255,255,0.04);
      --muted:#9aa4b2; --accent:#60a5fa; --accent-2:#00c896;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;min-height:100vh;background:var(--bg-dark);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:24px;transition:background .3s,color .3s}
    body.light{background:#f7fafc;color:#111}
    .app{width:1000px;max-width:100%;border-radius:14px;padding:22px;background:var(--card-dark);backdrop-filter:blur(6px);box-shadow:0 12px 40px rgba(0,0,0,0.4)}
    body.light .app{background:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .muted{opacity:.75;font-size:13px}
    .btn{background:var(--accent);color:#03213a;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    body.light .btn{background:var(--accent-2);color:#fff}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:7px 10px;border-radius:8px;cursor:pointer}
    main{display:grid;grid-template-columns:320px 1fr;gap:20px}
    .card{padding:16px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    body.light .card{background:#fff;border-color:#eee}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:10px}
    body.light input{border-color:#ddd;background:#fafafa;color:#111}
    .session{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03)}
    .deleteBtn{background:#d9534f;color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
    .toast{position:fixed;bottom:20px;right:20px;padding:10px 16px;border-radius:8px;color:#fff;z-index:9999}
    .toast.success{background:#28a745}.toast.error{background:#d9534f}.toast.info{background:#2196f3}

    /* Sidebar */
    #sidebar{position:fixed;left:-260px;top:0;width:260px;height:100vh;background:#111827;color:#fff;padding:18px;transition:left .28s;z-index:120}
    #sidebar.active{left:0}
    #sidebar h2{margin:0 0 12px 0}
    .sidebar-toggle{position:fixed;top:18px;left:18px;padding:8px 12px;border-radius:8px;background:#16a34a;color:#fff;border:0;cursor:pointer;z-index:125}
    /* overlay starts hidden and only shown when sidebar has .active via general sibling */
    #sidebarOverlay{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);display:none;z-index:119}
    /* use general sibling selector so it works even if there are elements between sidebar and overlay */
    #sidebar.active ~ #sidebarOverlay{display:block}

    /* stats & ring */
    .stats-panel{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .progress-ring{position:relative;width:100px;height:100px}
    .ring-bg{fill:none;stroke:rgba(255,255,255,0.15);stroke-width:10}
    .ring-progress{fill:none;stroke:var(--accent-2);stroke-width:10;stroke-linecap:round;transform-origin:50% 50%;transform:rotate(-90deg);stroke-dasharray:283;stroke-dashoffset:283;transition:stroke-dashoffset .9s ease}
    .ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:700;font-size:1rem}

    /* responsive */
    @media(max-width:780px){
      main{grid-template-columns:1fr}
      .app{padding:14px;width:calc(100% - 48px);}
      /* don't force the overlay on mobile unless sidebar is active (handled by the sibling selector) */
      .app.hidden{display:none}
      /* touch-friendly buttons */
      .btn, .ghost, .deleteBtn { padding:12px 14px; font-size:16px; }
      .sidebar-toggle{left:12px;top:12px}
    }
    .hidden{display:none}
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div class="app" id="loginDiv">
    <header><h1>Login / Sign Up</h1></header>

    <section class="card">
      <h3>Sign Up</h3>
      <input id="signupUser" placeholder="Email" />
      <input id="signupPass" type="password" placeholder="Password" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="signupBtn">Sign Up</button>
        <button class="ghost" id="demoBtn">Try Demo</button>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h3>Login</h3>
      <input id="loginUser" placeholder="Email" />
      <input id="loginPass" type="password" placeholder="Password" />
      <button class="btn" id="loginBtn" style="margin-top:8px">Login</button>
    </section>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2 id="logo">Coding Tracker</h2>
    <nav>
      <button class="ghost" id="homeBtn">üè† Home</button>
      <button class="ghost" id="sessionsBtn">üìÖ Sessions</button>
      <button class="ghost" id="statsBtn">üìä Stats</button>
    </nav>
  </div>
  <button class="sidebar-toggle" id="toggleSidebar">‚ò∞ Menu</button>
  <div id="sidebarOverlay"></div>

  <!-- MAIN TRACKER -->
  <div class="app hidden" id="trackerDiv">
    <header>
      <div>
        <h1>Coding Practice Tracker</h1>
        <div class="muted">Search ¬∑ Chart ¬∑ Monthly Summary</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="ghost" id="themeToggle">üåô/‚òÄ</button>
        <button class="ghost" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h3>Add Session</h3>
        <input id="title" placeholder="Title" />
        <input id="lang" placeholder="Language" />
        <input id="duration" type="number" placeholder="Duration (min)" />
        <input id="date" type="date" />
        <button class="btn" id="add">Add</button>
        <div style="margin-top:16px">
          <h4>Monthly Summary</h4>
          <div class="muted" id="monthlySummary">This month: 0 sessions, 0 minutes.</div>
        </div>
      </section>

      <section class="card">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <input id="searchInput" placeholder="Search title or language" />
          <button class="btn" id="searchBtn">Search</button>
          <button class="ghost" id="clearSearch">Clear</button>
        </div>

        <div class="stats-panel">
          <div class="progress-ring" aria-hidden="true">
            <svg width="100" height="100">
              <circle class="ring-bg" cx="50" cy="50" r="45" />
              <circle class="ring-progress" cx="50" cy="50" r="45" />
            </svg>
            <div class="ring-text" id="progressText">0%</div>
          </div>
          <div class="chart-panel" style="flex:1">
            <canvas id="myChart" height="140"></canvas>
          </div>
        </div>

        <h4 style="margin-top:18px">Sessions</h4>
        <div id="list"></div>
      </section>
    </main>
  </div>

  <div id="toast-container"></div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyABXaiOa64dWWU6D1YkM4GJ6DF5ppZWypM",
  authDomain: "codingtracker-ff754.firebaseapp.com",
  projectId: "codingtracker-ff754",
  storageBucket: "codingtracker-ff754.firebasestorage.app",
  messagingSenderId: "551030062915",
  appId: "1:551030062915:web:a553a89006b59234ea79f6",
  measurementId: "G-TKFKWBERNZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let sessions = [];
let storageKey = 'guest';
let chart = null;

const toast = (msg, type='info') => {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(()=> el.remove(), 1800);
};

// ---------- Tracker functions ----------
function getWeekNumber(d){
  const first = new Date(d.getFullYear(),0,1);
  const diff = Math.floor((d-first)/86400000);
  return Math.ceil((diff + first.getDay() + 1) / 7);
}

function calculateChartData() {
  const weekMap = {};
  sessions.forEach(s=>{
    const d = new Date(s.date);
    if (isNaN(d)) return;
    const w = getWeekNumber(d);
    weekMap[w] = (weekMap[w] || 0) + Number(s.duration || 0);
  });
  const labels = Object.keys(weekMap).sort((a,b)=>a-b);
  const values = labels.map(l=>weekMap[l]);
  return { labels, values };
}

function updateChart() {
  const ctx = document.getElementById('myChart').getContext('2d');
  const { labels, values } = calculateChartData();
  try { if (chart) chart.destroy(); } catch(e){}
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label:'Minutes per week', data: values, backgroundColor:'rgba(75,192,192,0.28)', borderColor:'rgba(75,192,192,1)', borderWidth:1 }]},
    options: { scales:{ y:{ beginAtZero:true } }, maintainAspectRatio: false }
  });
}

function updateProgressRing(percentage) {
  const circle = document.querySelector('.ring-progress');
  const text = document.getElementById('progressText');
  if(!circle) return;
  const radius = circle.r.baseVal.value;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference - (Math.max(0, Math.min(100, percentage)) / 100) * circumference;
  circle.style.strokeDasharray = circumference;
  circle.style.strokeDashoffset = offset;
  text.textContent = `${Math.round(percentage)}%`;
}

function updateMonthlySummary() {
  const now = new Date();
  const month = sessions.filter(s=>{
    const d = new Date(s.date);
    return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
  });
  const total = month.reduce((a,v)=>a+Number(v.duration||0),0);
  document.getElementById('monthlySummary').textContent = `This month: ${month.length} sessions, ${total} minutes.`;
  const weekTotal = sessions.reduce((acc,v)=>{
    const d = new Date(v.date);
    const now = new Date();
    if (getWeekNumber(d)===getWeekNumber(now)) return acc+Number(v.duration||0);
    return acc;
  },0);
  updateProgressRing(Math.min(100,(weekTotal/300)*100));
}

function render(list=sessions){
  const el=document.getElementById('list');
  el.innerHTML='';
  list.forEach((s,i)=>{
    const div=document.createElement('div');
    div.className='session';
    div.innerHTML=`<div><b>${s.title}</b><br><span class="muted">${s.lang}</span><br><small>${s.duration} mins ‚Ä¢ ${s.date}</small></div>`;
    const btn=document.createElement('button');
    btn.className='deleteBtn';btn.textContent='Delete';
    btn.onclick=async()=>{sessions.splice(i,1);save();render();toast('Deleted','error')};
    div.appendChild(btn);el.appendChild(div);
  });
  updateMonthlySummary();updateChart();
}

function save(){ if(storageKey==='guest')sessionStorage.setItem('sessions',JSON.stringify(sessions)); }

// ---------- FIREBASE AUTH & UI wiring ----------
document.addEventListener('DOMContentLoaded',()=>{
  const loginDiv=document.getElementById('loginDiv');
  const trackerDiv=document.getElementById('trackerDiv');

  // grab commonly used inputs (important in module context)
  const title = document.getElementById('title');
  const lang = document.getElementById('lang');
  const duration = document.getElementById('duration');
  const date = document.getElementById('date');
  const searchInput = document.getElementById('searchInput');

  // Sidebar toggle functionality
  const toggleSidebar = document.getElementById('toggleSidebar');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const appContainer = document.getElementById('trackerDiv');

  toggleSidebar.addEventListener('click', () => {
    sidebar.classList.toggle('active');
    if (sidebar.classList.contains('active')) {
      sidebarOverlay.style.display = 'block';
      appContainer.classList.add('hidden');
    } else {
      sidebarOverlay.style.display = 'none';
      appContainer.classList.remove('hidden');
    }
  });

  sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.style.display = 'none';
    appContainer.classList.remove('hidden');
  });

  // Demo Mode
  document.getElementById('demoBtn').onclick=()=>{
    storageKey='guest';
    sessions=JSON.parse(sessionStorage.getItem('sessions')||'[]');
    loginDiv.classList.add('hidden');
    trackerDiv.classList.remove('hidden');
    render();
  };

  // Sign Up
  document.getElementById('signupBtn').onclick=async()=>{
    const email=document.getElementById('signupUser').value.trim();
    const pass=document.getElementById('signupPass').value.trim();
    if(!email||!pass) return toast('Enter email & password','error');
    try{
      await createUserWithEmailAndPassword(auth,email,pass);
      toast('Account created!','success');
    }catch(err){
      toast(err.message,'error');
    }
  };

  // Login
  document.getElementById('loginBtn').onclick=async()=>{
    const email=document.getElementById('loginUser').value.trim();
    const pass=document.getElementById('loginPass').value.trim();
    if(!email||!pass) return toast('Enter login credentials','error');
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      toast('Logged in!','success');
    }catch(err){
      toast(err.message,'error');
    }
  };

  // Auth state change
  onAuthStateChanged(auth,(user)=>{
    if(user){
      console.log('User logged in:',user.email);
      storageKey='firebase';
      loginDiv.classList.add('hidden');
      trackerDiv.classList.remove('hidden');
    }else{
      console.log('No user logged in');
      loginDiv.classList.remove('hidden');
      trackerDiv.classList.add('hidden');
    }
  });

  // Add Session (use element references above)
  document.getElementById('add').onclick=()=>{
    const t=title.value.trim(), l=lang.value.trim(), d=parseInt(duration.value)||0, dt=date.value||new Date().toISOString().slice(0,10);
    if(!t||!l) return toast('Fill details','error');
    sessions.push({title:t,lang:l,duration:d,date:dt});
    save();render();toast('Added','success');
    // clear inputs for quick mobile flow
    title.value=''; lang.value=''; duration.value=''; date.value='';
  };

  // Search + Clear
  document.getElementById('searchBtn').onclick=()=>{
    const q=searchInput.value.toLowerCase();
    render(sessions.filter(s=>(s.title||'').toLowerCase().includes(q)||(s.lang||'').toLowerCase().includes(q)));
  };
  document.getElementById('clearSearch').onclick=()=>{searchInput.value='';render();};

  // Theme toggle
  document.getElementById('themeToggle').onclick=()=>{document.body.classList.toggle('light');};

  // Logout
  document.getElementById('logoutBtn').onclick=async()=>{
    try{await signOut(auth);}catch(e){}
    sessions=[];sessionStorage.clear();
    trackerDiv.classList.add('hidden');loginDiv.classList.remove('hidden');
  };
});
</script>
</body>
</html>